{% extends 'base.html' %}
{% block title %}
统计
{% endblock title %}
{% block sidebar %}
<div class="col-md-2 sidebar">
    <ul class="nav nav-sidebar">
        {% for habit in habits %}
            {% if habit_id == habit.id %}
                <li class="active"><a href="{{ url_for('statistics', habit_id=habit.id) }}">{{ habit.habit_name }}</a></li>
            {% else %}
                <li><a href="{{ url_for('statistics', habit_id=habit.id) }}">{{ habit.habit_name }}</a></li>
            {% endif %}
        {% endfor %}
    </ul>
</div>
{% endblock sidebar %}
{% block main %}
<div class="col-md-10 col-md-offset-2 main">
    {% if habit_id == 0 %}
        <h1>在左侧选择要进行统计的习惯</h1>
    {% else %}
        <p id="habit_id" class="hidden">{{ habit_id }}</p>
        <div class="row">
            <div class="col-md-6" id="pie_month" style="width: 500px;height: 500px"></div>
            <div class="col-md-6" id="pie_year" style="width: 500px;height: 500px"></div>
        </div>
        <div class="row">
            <div id="heat_map" style="width: 1200px;height: 500px"></div>
        </div>
    {% endif %}
</div>
<script type="text/javascript">
    
    var day1 = new Date();
    year = day1.getFullYear();
    
    // 初始化图表
    var pie_month = echarts.init(document.getElementById('pie_month'));
    var pie_year = echarts.init(document.getElementById('pie_year'));
    var heat_map = echarts.init(document.getElementById('heat_map'));

    var option_month = {
        title: {
            text: '月统计'
        },
        tooltip: {},
        series: [{
            type: 'pie',
            label: {
                show: true
            },
            data: []
        }]
    };
    var option_year = {
        title: {
            text: '年统计'
        },
        tooltip: {},
        series: [{
            type: 'pie',
            label: {
                show: true
            },
            data: []
        }]
    };
    var option_heatMap = {
        visualMap: {
            show: false,
            min: 0,
            max: 1
        },
        calendar: {
            range: year
        },
        series: {
            type: 'heatmap',
            coordinateSystem: 'calendar'
        }
    };

    pie_month.setOption(option_month);
    pie_year.setOption(option_year);
    heat_map.setOption(option_heatMap);

    pie_month.showLoading(); 
    pie_year.showLoading();
    heat_map.showLoading();

    var names = ["已完成", "未完成"];
    var month_data = [];
    var year_data = [];
    var habit_id = $("#habit_id").text();

    $.ajax({
        type : "get",
        url : "http://127.0.0.1:5000/echarts/"+habit_id, 
        dataType : "json", 
        success : function(result) {
            if (result) {

                //月统计加载
                for(var i=0; i<result["month_data"].length; i++){
                    month_data.push({"name":names[i],"value":result["month_data"][i]["value"]});
                }

                pie_month.hideLoading();  
                pie_month.setOption({    
                    series: [{
                        data: month_data
                    }]
                });

                //年统计加载
                for(var i=0; i<result["year_data"].length; i++){
                    year_data.push({"name":names[i],"value":result["year_data"][i]["value"]});
                }

                pie_year.hideLoading();  
                pie_year.setOption({    
                    series: [{
                        data: year_data
                    }]
                });

                //热力图加载
                var date = +echarts.number.parseDate(year + '-01-01');
                var end = +echarts.number.parseDate(year + '-12-31');
                var dayTime = 3600 * 24 * 1000;
                var data = [];
                for (var time = date; time <= end; time += dayTime) {
                    data.push([
                        echarts.format.formatTime('yyyy-MM-dd', time),
                        0
                    ]);
                }
                for(var i=0; i<result["complete_days"].length; i++){
                    data.push([
                        result["complete_days"][i],
                        1
                    ]);
                }
                heat_map.hideLoading();
                heat_map.setOption({
                    series: [{
                        data: data
                    }]
                })

                

            }

       },
        error : function(errorMsg) {
            alert("图表请求数据失败!");
            pie_month.hideLoading();
        }
   })

</script>
{% endblock main %}

